<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>æ•°æ®ç»“æ„å­¦ä¹ ä¹‹è·¯(ä¸‰)ï¼šSDSç®€å•åŠ¨æ€å­—ç¬¦ä¸² | é¸¡æ¯›è’œçš®äº‹(â—&#39;â—¡&#39;â—)</title>

<link rel="shortcut icon" href="http://mofish.pily.life/favicon.ico?v=1689146956047">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="http://mofish.pily.life/styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<style>
    hr {
        margin-top: 1rem;
        margin-bottom: 1rem;
        border: 0;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <style>
    /* å¯¼èˆªæ æ ·å¼ */
    .navbar {
        position: relative;
        display: -ms-flexbox;
        display: flex;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
        -ms-flex-align: center;
        align-items: center;
        -ms-flex-pack: justify;
        justify-content: space-between;
        padding: 0.5rem 1rem;
    }

    .navbar-brand {
        display: inline-block;
        padding-top: 0.3125rem;
        padding-bottom: 0.3125rem;
        margin-right: 1rem;
        font-size: 1.25rem;
        line-height: inherit;
        white-space: nowrap;
    }

    .navbar-brand:hover,
    .navbar-brand:focus {
        text-decoration: none;
    }

    .navbar-nav {
        display: -ms-flexbox;
        display: flex;
        -ms-flex-direction: column;
        flex-direction: column;
        padding-left: 0;
        margin-bottom: 0;
        list-style: none;
    }

    .navbar-collapse {
        -ms-flex-preferred-size: 100%;
        flex-basis: 100%;
        -ms-flex-positive: 1;
        flex-grow: 1;
        -ms-flex-align: center;
        align-items: center;
    }

    .navbar-toggler {
        padding: 0.25rem 0.75rem;
        font-size: 1.25rem;
        line-height: 1;
        background-color: transparent;
        border: 1px solid transparent;
        border-radius: 0.25rem;
    }

    .navbar-toggler:hover,
    .navbar-toggler:focus {
        text-decoration: none;
    }

    @media (min-width: 992px) {
        .navbar-expand-lg {
            -ms-flex-flow: row nowrap;
            flex-flow: row nowrap;
            -ms-flex-pack: start;
            justify-content: flex-start;
        }

        .navbar-expand-lg .navbar-nav {
            -ms-flex-direction: row;
            flex-direction: row;
        }

        .navbar-expand-lg .navbar-collapse {
            display: -ms-flexbox !important;
            display: flex !important;
            -ms-flex-preferred-size: auto;
            flex-basis: auto;
        }

        .navbar-expand-lg .navbar-toggler {
            display: none;
        }
    }

    @media (max-width: 991px) {
        #navbarSupportedContent {
            display: none;
        }
    }
</style>
<nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="å¤´åƒ">
        <div class="site-name gt-c-content-color-first">
            é¸¡æ¯›è’œçš®äº‹(â—&#39;â—¡&#39;â—)
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    é¦–é¡µ
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tags" class="menu gt-a-link">
                    æ ‡ç­¾
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/archives" class="menu gt-a-link">
                    å½’æ¡£
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/post/about" class="menu gt-a-link">
                    å…³äº
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1689146956047"
                action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="æœç´¢æ–‡ç« " />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* ç§»åŠ¨ç«¯å¯¼èˆªæ å±•å¼€/æ”¶èµ·åˆ‡æ¢ */
    document.getElementById('changeNavbar').onclick = function () {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>
    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    æ•°æ®ç»“æ„å­¦ä¹ ä¹‹è·¯(ä¸‰)ï¼šSDSç®€å•åŠ¨æ€å­—ç¬¦ä¸²
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        Â· 2021-09-17 Â·
                    </time>
                    
                        <a href="http://mofish.pily.life/tag/P-RRy8DydH/" class="post-tags">
                            # redis
                        </a>
                    
                        <a href="http://mofish.pily.life/tag/J4LLJ1xJr/" class="post-tags">
                            # æ•°æ®ç»“æ„
                        </a>
                    
                </div>
                <div class="post-content">
                    <p>ğŸ‘‰ç®€å•åŠ¨æ€å­—ç¬¦ä¸²SDSæ˜¯Redisä¸­Stringç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„</p>
<p>ğŸ‘‰Redisçš„å®ç°æ–¹æ³•å¹¶æ²¡ç”¨é‡‡ç”¨ä¼ ç»Ÿçš„Cè¯­è¨€ä¸­çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œè€Œæ˜¯é€šè¿‡æ”¹è¿›åè‡ªå·±å®šä¹‰äº†ä¸€ç§å«åšç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆsimple dynamic string, ç®€ç§°SDSï¼‰çš„æŠ½è±¡ç±»å‹ã€‚</p>
<!-- more -->
<p>æ­¤å¤–SDSåœ¨å…¼å®¹Cè¯­è¨€æ ‡å‡†å­—ç¬¦ä¸²æå…¶å¤„ç†å‡½æ•°å¤–ï¼Œè¿˜åœ¨æ­¤åŸºç¡€ä¸Šä¿è¯äº†<code>äºŒè¿›åˆ¶å®‰å…¨</code>ï¼Œä¸‹é¢æˆ‘ä»¬å°†è¯¦ç»†çš„ä»‹ç»SDSçš„å®ç°ã€‚</p>
<p>PSâ—ï¸ï¼šäºŒè¿›åˆ¶å®‰å…¨é€šä¿—åœ°è®²ï¼ŒC è¯­è¨€ä¸­ï¼Œç”¨ &quot;\0&quot; è¡¨ç¤ºå­—ç¬¦ä¸²çš„ç»“æŸï¼Œ å¦‚æœå­—ç¬¦ä¸²ä¸­æœ¬èº«å°±æœ‰ &quot;\0&quot; å­—ç¬¦ï¼Œå­—ç¬¦ä¸²å°±ä¼šè¢«æˆªæ–­ï¼Œå³éäºŒè¿›åˆ¶å®‰å…¨ï¼›è‹¥é€šè¿‡æŸç§æœºåˆ¶ï¼Œä¿è¯è¯»å†™å­—ç¬¦ä¸²æ—¶ä¸æŸå®³å…¶å†…å®¹ï¼Œåˆ™æ˜¯äºŒè¿›åˆ¶å®‰å…¨ã€‚</p>
<h3 id="a-nameæ•°æ®ç»“æ„æ•°æ®ç»“æ„a"><a name="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</a></h3>
<p>åœ¨Redisä¸­ï¼ŒSDSæ ¹æ®å­—ç¬¦ä¸²é•¿çŸ­å®šä¹‰äº†5ç§æ•°æ®æ¥å£ï¼Œåˆ†åˆ«å« sdshdr5ã€sdshdr8ã€sdshdr16ã€sdshdr32 å’Œ sdshdr64ï¼Œå…¶ç»“æ„ä½“å¦‚ä¸‹ã€‚</p>
<pre><code class="language-C">sds.h

//å®šä¹‰äº†ä¸€ä¸ªchar æŒ‡é’ˆ
typedef char *sds;

/* Note: sdshdr5 is never used, we just access the flags byte directly.
 * However is here to document the layout of type 5 SDS strings. */

struct __attribute__ ((__packed__)) sdshdr5 {
    unsigned char flags;  /* ä½ä¸‰ä½å­˜ç±»å‹, é«˜äº”ä½å­˜é•¿åº¦ */
    char buf[];  /* æŸ”æ€§æ•°ç»„ï¼Œå­˜æ”¾å®é™…å†…å®¹ */
};

struct __attribute__ ((__packed__)) sdshdr8 {
   //buf å·²ç»ä½¿ç”¨çš„é•¿åº¦
    uint8_t len;  /* å·²ä½¿ç”¨é•¿åº¦ï¼Œç”¨ 1 å­—èŠ‚å­˜ */

    //buf åˆ†é…çš„é•¿åº¦ï¼Œç­‰äºbuf[]çš„æ€»é•¿åº¦-1ï¼Œå› ä¸ºbufæœ‰åŒ…æ‹¬ä¸€ä¸ª/0çš„ç»“æŸç¬¦
    uint8_t alloc;  /* æ€»é•¿åº¦ï¼Œç”¨ 1 å­—èŠ‚å­˜ */

    //åªæœ‰3ä½æœ‰æ•ˆä½ï¼Œå› ä¸ºç±»å‹çš„è¡¨ç¤ºå°±æ˜¯0åˆ°4ï¼Œæ‰€æœ‰è¿™ä¸ª8ä½çš„flags æœ‰5ä½æ²¡æœ‰è¢«ç”¨åˆ°
    unsigned char flags;  /* ä½ä¸‰ä½å­˜ç±»å‹, é«˜äº”ä½é¢„ç•™ */
    
    //å®é™…çš„å­—ç¬¦ä¸²å­˜åœ¨è¿™é‡Œ
    char buf[];  /* æŸ”æ€§æ•°ç»„ï¼Œå­˜æ”¾å®é™…å†…å®¹ */
};

// ä¸ä¸Šé¢çš„å˜åŒ–åªæœ‰lenå’Œallocï¼Œ å°±æ˜¯é•¿åº¦ä¸åŒè€Œå·²
struct __attribute__ ((__packed__)) sdshdr16 {
    uint16_t len;  /* å·²ä½¿ç”¨é•¿åº¦ï¼Œç”¨ 2 å­—èŠ‚å­˜ */
    uint16_t alloc; /* æ€»é•¿åº¦ï¼Œç”¨ 2 å­—èŠ‚å­˜ */
    unsigned char flags; /* ä½ä¸‰ä½å­˜ç±»å‹, é«˜äº”ä½é¢„ç•™ */
    char buf[];
};

// ä¸ä¸Šé¢çš„å˜åŒ–åªæœ‰lenå’Œallocï¼Œ å°±æ˜¯é•¿åº¦ä¸åŒè€Œå·²
struct __attribute__ ((__packed__)) sdshdr32 {
    uint32_t len; /* å·²ä½¿ç”¨é•¿åº¦ï¼Œç”¨ 4 å­—èŠ‚å­˜ */
    uint32_t alloc;  /* æ€»é•¿åº¦ï¼Œç”¨ 4 å­—èŠ‚å­˜ */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};

// ä¸ä¸Šé¢çš„å˜åŒ–åªæœ‰lenå’Œallocï¼Œ å°±æ˜¯é•¿åº¦ä¸åŒè€Œå·²
struct __attribute__ ((__packed__)) sdshdr64 {
    uint64_t len; /* å·²ä½¿ç”¨é•¿åº¦ï¼Œç”¨ 8 å­—èŠ‚å­˜ */
    uint64_t alloc;  /* æ€»é•¿åº¦ï¼Œç”¨ 8 å­—èŠ‚å­˜ */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
</code></pre>
<br>
<p>è¿™äº”ç§ç»“æ„ä½“ä¸­çš„å­—æ®µå®šä¹‰å¦‚ä¸‹ğŸ‘‡ï¼š</p>
<ul>
<li>lenï¼šè¡¨ç¤º buf ä¸­å·²å ç”¨çš„å­—èŠ‚æ•°ï¼›</li>
<li>allocï¼šè¡¨ç¤º buf ä¸­å·²åˆ†é…çš„å­—èŠ‚æ•°ï¼Œè®°å½•çš„æ˜¯ buf åˆ†é…çš„æ€»é•¿åº¦ï¼›</li>
<li>flagsï¼šæ ‡è¯†å½“å‰ç»“æ„ä½“çš„ç±»å‹ï¼Œä½ä¸‰ä½å­˜ç±»å‹, é«˜äº”ä½é¢„ç•™ï¼›</li>
<li>bufï¼šæŸ”æ€§æ•°ç»„ï¼ŒçœŸæ­£å­˜å‚¨å­—ç¬¦ä¸²çš„æ•°æ®ç©ºé—´ã€‚</li>
</ul>
<br>
<p>ä¹‹æ‰€ä»¥åˆ†æˆè¿™ä¸ªå¤šä¸åŒç±»å‹çš„ç»“æ„ä½“ï¼Œå…¶ä¼˜ç‚¹æ˜¯ğŸ¤™ğŸ¤™</p>
<ul>
<li>ä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²ç”¨ä¸åŒçš„çš„ç±»å‹è¡¨ç¤ºï¼ŒèŠ‚çº¦å†…å­˜</li>
<li>æœ‰å•ç‹¬çš„ç»Ÿè®¡å˜é‡<code>len</code>å’Œ<code>alloc</code>ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¾—åˆ°å­—ç¬¦ä¸²é•¿åº¦</li>
<li>SDS å¯¹ä¸Šå±‚æš´éœ²çš„æŒ‡é’ˆæ˜¯ç›´æ¥æŒ‡å‘æŸ”æ€§æ•°ç»„ buf çš„ï¼Œå…¼å®¹ C è¯­è¨€å¤„ç†å­—ç¬¦ä¸²çš„å„ç§å‡½æ•°</li>
<li>ç”±äºæœ‰é•¿åº¦ç»Ÿè®¡å˜é‡ len çš„å­˜åœ¨ï¼Œè¯»å†™å­—ç¬¦ä¸²æ—¶ä¸ä¾èµ– &quot;\0&quot; ç»ˆæ­¢ç¬¦ï¼Œä¿è¯äº†äºŒè¿›åˆ¶å®‰å…¨</li>
</ul>
<figure data-type="image" tabindex="1"><img src="http://mofish.pily.life/post-images/1615988723570.jpg" alt="" width="200" height="200" loading="lazy"></figure>
<p>ä¸‹é¢æ¥è¯¦ç»†çœ‹ä¸€ä¸‹è¿™å‡ ç§ sdshdr çš„ç»“æ„ï¼Œsdshdr8ã€sdshdr16ã€sdshdr32 å’Œ sdshdr64 çš„ç»“æ„ç›¸åŒ<br>
<code>sdshdr16</code>ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š<br>
<img src="http://mofish.pily.life/post-images/1648603369505.png" alt="" loading="lazy"></p>
<p><code>sdshdr5</code>ä¸ä¸Šè¿°çš„ä¸åŒï¼Œåšäº†è¿›ä¸€æ­¥çš„å‹ç¼©ï¼Œç”¨ flags ä¸­é¢„ç•™çš„ 5 ä½å­˜é•¿åº¦ï¼ŒæŠŠ len å’Œ alloc ä¹Ÿçœæ‰äº†ï¼Œå…¶ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š<br>
<img src="http://mofish.pily.life/post-images/1648603376187.png" alt="" loading="lazy"></p>
<p>åœ¨ Redis çš„æºä»£ç ä¸­ï¼Œå¯¹ç±»å‹çš„å®å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code class="language-C">#define SDS_TYPE_5  0
#define SDS_TYPE_8  1
#define SDS_TYPE_16 2
#define SDS_TYPE_32 3
#define SDS_TYPE_64 4
</code></pre>
<p>æºç ä¸­çš„ <strong>attribute</strong>((<strong>packed</strong>)) éœ€è¦é‡ç‚¹å…³æ³¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç»“æ„ä½“ä¼šæŒ‰å…¶æ‰€æœ‰å˜é‡å¤§å°çš„æœ€å°å…¬å€æ•°åšå­—èŠ‚å¯¹é½ï¼Œè€Œç”¨ packed ä¿®é¥°åï¼Œç»“æ„ä½“åˆ™å˜ä¸ºæŒ‰ 1 å­—èŠ‚å¯¹é½ã€‚</p>
<p>ä»¥ sdshdr32 ä¸ºä¾‹ï¼Œä¿®é¥°å‰æŒ‰ 4 å­—èŠ‚å¯¹é½ï¼Œå¤§å°ä¸º 12 å­—èŠ‚ï¼›ä¿®é¥°åæŒ‰ 1 å­—èŠ‚å¯¹é½ï¼Œæ³¨æ„ buf æ˜¯ä¸ª char ç±»å‹çš„æŸ”æ€§æ•°ç»„ï¼Œåœ°å€è¿ç»­ï¼Œå§‹ç»ˆåœ¨ flags ä¹‹åã€‚packed ä¿®é¥°å‰åç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š<br>
<img src="http://mofish.pily.life/post-images/1648603529832.png" alt="" loading="lazy"></p>
<p>è¿™æ ·çš„å¥½å¤„æœ‰ä¸¤ä¸ªï¼š<br>
1ï¸âƒ£èŠ‚çœå†…å­˜ï¼Œä¾‹å¦‚ sdshdr32 å¯èŠ‚çœ 3 ä¸ªå­—èŠ‚ï¼›</p>
<p>2ï¸âƒ£SDS è¿”å›ç»™ä¸Šå±‚çš„ï¼Œä¸æ˜¯ç»“æ„ä½“é¦–åœ°å€ï¼Œè€Œæ˜¯æŒ‡å‘å†…å®¹çš„ buf æŒ‡é’ˆ sã€‚ä¿®é¥°åï¼Œæ— è®ºæ˜¯ sdshdr8ã€sdshdr16 è¿˜æ˜¯ sdshdr32ï¼Œéƒ½èƒ½é€šè¿‡ s[-1] å¿«é€Ÿæ‰¾åˆ° flagsï¼Œå› ä¸ºæ­¤æ—¶æŒ‰ 1 å­—èŠ‚å¯¹é½ã€‚è‹¥æ²¡æœ‰ packed çš„ä¿®é¥°ï¼Œè¿˜éœ€è¦å¯¹ä¸åŒç»“æ„åšå¤„ç†ï¼Œå®ç°æ›´å¤æ‚ã€‚</p>
<h3 id="a-nameä¸¤å¤§ç‰¹ç‚¹ä¸¤å¤§ç‰¹ç‚¹a"><a name="ä¸¤å¤§ç‰¹ç‚¹">ä¸¤å¤§ç‰¹ç‚¹</a></h3>
<h4 id="ç©ºé—´é¢„åˆ†é…">ç©ºé—´é¢„åˆ†é…</h4>
<p>å­—ç¬¦ä¸²æ‹¼æ¥æ˜¯å­—ç¬¦ä¸²ä¸­æœ€å¸¸ç”¨çš„æ“ä½œï¼Œåœ¨SDSä¸­å…·ä½“çš„å‡½æ•°æ˜¯<code>sdscatsds</code>ï¼š</p>
<pre><code class="language-C">sds sdscatsds(sds s, const sds t) {
    return sdscatlen(s, t, sdslen(t));
}
</code></pre>
<p>ä½†æ˜¯<code>sdscatsds</code>åªæ˜¯æš´éœ²ç»™ä¸Šå±‚çš„æ–¹æ³•ï¼Œå…¶æœ€ç»ˆè°ƒç”¨çš„å‡½æ•°æ˜¯<code>sdscatlen</code>ï¼š</p>
<pre><code class="language-C">/* å°†æŒ‡é’ˆ t çš„å†…å®¹å’ŒæŒ‡é’ˆ s çš„å†…å®¹æ‹¼åœ¨ä¸€èµ·ï¼Œè¯¥æ“ä½œæ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ */
sds sdscatlen(sds s, const void *t, size_t len) {
    size_t curlen = sdslen(s);

    s = sdsMakeRoomFor(s,len);  // æ‰©å®¹æ£€æŸ¥ï¼Œå¦‚éœ€æ‰©å®¹åˆ™è¿”å›æ‰©å®¹å¥½çš„æ–°çš„å­—ç¬¦ä¸²
    if (s == NULL) return NULL;
    memcpy(s+curlen, t, len);  // ç›´æ¥æ‹¼æ¥ï¼Œä¿è¯äº†äºŒè¿›åˆ¶å®‰å…¨
    sdssetlen(s, curlen+len);
    s[curlen+len] = '\0';  // åŠ ä¸Šç»“æŸç¬¦ä»¥ä¿æŒå…¼å®¹
    return s;
}
</code></pre>
<p>ç”±äºå…¶ä¸­å¯èƒ½æ¶‰åŠ SDS çš„æ‰©å®¹ï¼Œsdscatlen ä¸­è°ƒç”¨ sdsMakeRoomFor å¯¹å¾…æ‹¼æ¥çš„å­—ç¬¦ä¸² s å®¹é‡åšäº†æ£€æŸ¥ï¼Œè‹¥æ— é¡»æ‰©å®¹åˆ™ç›´æ¥è¿”å› sï¼›è‹¥éœ€è¦æ‰©å®¹ï¼Œè¿”å›çš„åˆ™æ˜¯æ‰©å®¹å¥½çš„æ–°å­—ç¬¦ä¸²ã€‚</p>
<pre><code>å®¹é‡è®¡ç®—è§„åˆ™
â–ªï¸ æ‰©å®¹åé•¿åº¦å°äº 1MBï¼šæŒ‰æ–°é•¿åº¦çš„ 2 å€æ‰©å®¹ï¼›
â–ªï¸ æ‰©å®¹åé•¿åº¦è¶…è¿‡ 1MBï¼šæŒ‰æ–°é•¿åº¦åŠ ä¸Š 1MB æ‰©å®¹ã€‚

æ‰©å®¹å¯¹è±¡çš„é€‰æ‹©
â–ªï¸ SDS ç±»å‹æœªæ”¹å˜ï¼šé€šè¿‡ realloc æ‰©å¤§æŸ”æ€§æ•°ç»„ï¼›
â–ªï¸ SDS ç±»å‹å‘ç”Ÿå˜åŒ–ï¼šå¼€è¾Ÿæ–°å†…å­˜ï¼Œæ‹¼æ¥å®Œå†…å®¹åï¼Œé‡Šæ”¾æ—§æŒ‡é’ˆã€‚
</code></pre>
<p>â—ï¸â—ï¸é€šè¿‡ç©ºé—´é¢„åˆ†é…ç­–ç•¥ï¼Œ Redis å¯ä»¥å‡å°‘è¿ç»­æ‰§è¡Œå­—ç¬¦ä¸²å¢é•¿æ“ä½œæ‰€éœ€çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°ã€‚</p>
<br>
<h4 id="æƒ°æ€§ç©ºé—´é‡Šæ”¾">æƒ°æ€§ç©ºé—´é‡Šæ”¾</h4>
<p>Redis é€šè¿‡ sdsfree å‡½æ•°é‡Šæ”¾å­—ç¬¦ä¸²å çš„å†…å­˜ï¼Œè¯¥æ–¹æ³•é€šè¿‡å¯¹ s çš„åç§»ï¼Œå¯å®šä½åˆ° SDS ç»“æ„çš„é¦–éƒ¨ï¼Œå–å‡ºé•¿åº¦ lenï¼Œç„¶åè°ƒç”¨ s_free è¿›è¡Œå†…å­˜çš„é‡Šæ”¾ï¼š</p>
<pre><code class="language-C">void sdsfree(sds s) {
    if (s == NULL) return;
    s_free((char*)s-sdsHdrSize(s[-1]));  // å®šä½åˆ° SDS é¦–éƒ¨ï¼Œç›´æ¥é‡Šæ”¾å†…å­˜
}
</code></pre>
<p>â—ï¸â—ï¸ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼ˆå‡å°‘ç”³è¯·å†…å­˜çš„å¼€é”€ï¼‰ï¼ŒSDS æä¾›äº†ä¸ç›´æ¥é‡Šæ”¾å†…å­˜ï¼Œè€Œæ˜¯é€šè¿‡é‡ç½®ç»Ÿè®¡å€¼è¾¾åˆ°æ¸…ç©ºç›®çš„æ–¹æ³•ï¼šsdsclearï¼š</p>
<pre><code class="language-C">void sdsclear(sds s) {
    sdssetlen(s, 0);  // ç»Ÿè®¡å€¼ len æ¸…é›¶
    s[0] = '\0';  // æ¸…ç©º buf
}
</code></pre>
<p>è¯¥æ–¹æ³•ä»…å°† SDS çš„ len å½’é›¶ï¼Œæ­¤å¤„å·²å­˜åœ¨çš„ buf å¹¶æ²¡æœ‰çœŸæ­£è¢«æ¸…é™¤ï¼Œæ–°çš„æ•°æ®å¯ä»¥è¦†ç›–å†™ï¼Œè€Œä¸ç”¨é‡æ–°ç”³è¯·å†…å­˜ã€‚</p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">ä¸‹ä¸€ç¯‡</div>
                <a href="http://mofish.pily.life/post/data_structure_02/" class="post-title gt-a-link">
                    æ•°æ®ç»“æ„å­¦ä¹ ä¹‹è·¯(äºŒ)ï¼šå“ˆå¸Œè¡¨
                </a>
            </div>
        

        

        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">æ‰“å·¥äººï¼æ‰“å·¥é­‚ï¼æˆ‘çˆ±æ‰“å·¥ï¼</div>
    <div class="social-container">
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Powered by <a href="https://github.com/myx1002/myx1002.github.io" target="_blank">Moyuxing</a>
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="http://mofish.pily.life/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
